### Як Node.js сервер обробляє багато паралельних запитів на одному потоці?

Node.js здатен ефективно обробляти багато паралельних запитів, використовуючи **цикл подій (Event Loop)** та **неблокуючу модель вводу/виводу (non-blocking I/O)**. Основна ідея полягає в тому, що сервер не витрачає час на очікування завершення операцій вводу/виводу (наприклад, читання з бази даних або файлу), а натомість обробляє інші запити.

#### **Механізм обробки запитів**

1. **Отримання запиту**:
    - Коли сервер отримує новий запит, він передає його в цикл подій.

2. **Асинхронна операція**:
    - Якщо запит вимагає виконання операції вводу/виводу (наприклад, доступ до бази даних, зчитування файлу), Node.js делегує цю задачу на:
        - Операційну систему (для файлових операцій, мережі).
        - Внутрішні потоки libuv (для виконання певних задач у бекграунді).

3. **Повернення до циклу подій**:
    - У той час як операція виконується в іншому потоці чи через API операційної системи, Node.js повертається до циклу подій і готовий обробляти наступний запит.

4. **Колбек або проміс**:
    - Коли асинхронна операція завершується, результат (або помилка) повертається у вигляді події, яка додається до черги завдань (*callback queue*).
    - Цикл подій обробляє цю чергу, викликаючи відповідний колбек або розв'язуючи проміс.

#### **Цикл подій (Event Loop)**

Цикл подій є серцем Node.js. Він обробляє всі вхідні запити та асинхронні операції в кілька фаз:

1. **Timers**:
    - Виконуються колбеки таймерів (`setTimeout`, `setInterval`), чий час вийшов.

2. **I/O Callbacks**:
    - Обробляються колбеки завершених неблокуючих I/O операцій.

3. **Idle, Prepare**:
    - Виконуються внутрішні процеси Node.js.

4. **Poll**:
    - Очікуються нові запити вводу/виводу або обробляються наявні.

5. **Check**:
    - Виконуються колбеки, зареєстровані через `setImmediate`.

6. **Close Callbacks**:
    - Виконуються колбеки закриття (наприклад, `socket.on('close')`).

#### **Ключові особливості**

1. **Асинхронність**:
    - Завдяки неблокуючій моделі вводу/виводу Node.js не блокує цикл подій під час очікування завершення операцій.

2. **Неблокуючий I/O**:
    - Всі I/O операції в Node.js є неблокуючими: запит виконується в іншому потоці, і результат повертається через подію.

3. **Масштабованість**:
    - Оскільки Node.js не створює новий потік для кожного запиту, споживання пам'яті та ресурсів є значно нижчим, ніж у традиційних багатопоточних серверів.

#### **Порівняння з багатопоточними моделями**
| Модель                  | Як працює                                             | Недоліки                                  |
|-------------------------|-------------------------------------------------------|-------------------------------------------|
| **Node.js (Event Loop)**| Обробляє всі запити на одному потоці через асинхронність.| Не підходить для обчислювально складних задач. |
| **Багатопоточний сервер**| Кожен запит обробляється окремим потоком.             | Високе споживання ресурсів (RAM, CPU).    |

#### **Приклад обробки запиту**
```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  // Асинхронна операція
  setTimeout(() => {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('Hello, world!');
  }, 1000); // Відкладена відповідь на 1 секунду
});

server.listen(3000, () => {
  console.log('Server is running on port 3000');
});
```
* Поки один запит виконується (таймер на 1 секунду), Node.js здатен приймати та обробляти інші запити.

#### **Висновок**
Node.js здатен обробляти багато запитів одночасно завдяки неблокуючій моделі вводу/виводу та циклу подій. Це дозволяє створювати високопродуктивні сервери, які ефективно обробляють велику кількість одночасних клієнтів без потреби в багатопоточності.


| Попереднє питання                                                                  | Наступне питання                                                                                                                                                                      |
|------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [Які в Node.js головні компоненти?](4-what-are-the-main-components-of-node-js.md)  | [Чи можливо використовувати кілька потоків (threads)? За допомогою яких модулів це реалізовано?](6-is-it-possible-to-use-multiple-threads-what-modules-are-used-to-implement-this.md) |
