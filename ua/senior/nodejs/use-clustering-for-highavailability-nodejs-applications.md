#### * Use clustering for high-availability Node.js applications

Для забезпечення високої доступності (high availability) додатків, написаних на Node.js, можна використовувати кластеризацію. Це підхід, який дозволяє розгорнути декілька екземплярів програми на одному сервері та розподілити обробку між ними. Кластеризація допомагає максимізувати використання доступних CPU, так як Node.js працює в однопотоковому режимі.

### Основні кроки з використання кластерів в Node.js:

1. **Підключення модуля Cluster:**
   Для роботи з кластерами в Node.js використовується вбудований модуль `cluster`.

   ```javascript
   const cluster = require('cluster');
   const http = require('http');
   const numCPUs = require('os').cpus().length;
   ```

2. **Перевірка чи працює головний процес:**
   У процесі кластеризації розрізняють майстер-процес (головний) і воркер-процеси (робітники).

   ```javascript
   if (cluster.isMaster) {
     // Логіка для головного процесу
   } else {
     // Логіка для воркер-процесів
   }
   ```

3. **Запуск воркерів:**
   У головному процесі ми створюємо воркер-процеси, зазвичай на кожне ядро CPU.

   ```javascript
   if (cluster.isMaster) {
     console.log(`Master process ${process.pid} is running`);

     // Створити воркер для кожного ядра CPU
     for (let i = 0; i < numCPUs; i++) {
       cluster.fork();
     }

     cluster.on('exit', (worker, code, signal) => {
       console.log(`Worker ${worker.process.pid} died`);
       // Можна перезапустити воркер
       cluster.fork();
     });

   } else {
     // Воркер буде працювати, наприклад, з HTTP сервером
     http.createServer((req, res) => {
       res.writeHead(200);
       res.end('Hello world\n');
     }).listen(8000);

     console.log(`Worker ${process.pid} started`);
   }
   ```

4. **Обробка відмов (failover):**
   Реалізуйте логіку для автоматичного перезапуску воркерів у разі їх падіння. Це можна зробити шляхом прослуховування події `exit` для перезапуску нових воркерів.

5. **Обробка навантаження:**
   Важливо забезпечити балансування навантаження між воркерами, особливо якщо різні воркери підключені до зовнішніх ресурсів або баз даних.

6. **Використання зовнішніх рішень:**
   Для ще вищої доступності часто використовують зовнішні інструменти для балансування навантаження, такі як Nginx або HAProxy, які розподіляють трафік між кількома серверами з установленими Node.js кластерізованими програмами.

### Переваги:

- **Ефективніше використання CPU:** дозволяє використовувати всі ядра процесора.
- **Покращена стійкість до відмов:** падіння одного воркера не призводить до падіння всього додатку.
- **Легке масштабування:** додаючи нові воркери або сервери, можна легко масштабувати додаток.

Використання кластерів у Node.js є потужним інструментом для розробників, що прагнуть створити масштабовані та стійкі системи.

| Back | Forward |
|---|---|
| [Handle distributed systems communication in Node.js](/ua/senior/nodejs/handle-distributed-systems-communication-in-nodejs.md)  | [Contribute to the Node.js ecosystem](/ua/senior/nodejs/help-with-nodejs.md) |